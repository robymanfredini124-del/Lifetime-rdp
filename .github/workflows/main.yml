name: DEVXRDP â€“ Minimal Stable

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale Auth Key"
        required: true
        type: string

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 300

    steps:
      - uses: actions/checkout@v4

      # ---------- USER ----------
      - name: Create DEVXRDP User
        shell: powershell
        run: |
          $pass = ConvertTo-SecureString "Rdp!9Xq#2025" -AsPlainText -Force
          if (-not (Get-LocalUser DEVXRDP -ErrorAction SilentlyContinue)) {
            New-LocalUser DEVXRDP -Password $pass -AccountNeverExpires
            Add-LocalGroupMember Administrators DEVXRDP
          }

      # ---------- DIRECTORIES ----------
      - name: Prepare Directories
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force "C:\PersistentData"
          New-Item -ItemType Directory -Force "C:\Users\DEVXRDP\Downloads"
          New-Item -ItemType Directory -Force "C:\Users\DEVXRDP\AppData\Local\Google\Chrome\User Data"

      # ---------- RESTORE ----------
      - name: Restore Data
        uses: actions/cache/restore@v4
        with:
          path: |
            C:\PersistentData
            C:\Users\DEVXRDP\Downloads
            C:\Users\DEVXRDP\AppData\Local\Google\Chrome\User Data
          key: devxrdp-minimal

      # ---------- TAILSCALE ----------
      - name: Install Tailscale
        shell: powershell
        run: |
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi -OutFile tailscale.msi
          Start-Process msiexec.exe -Wait -ArgumentList "/i tailscale.msi /quiet"
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey "${{ inputs.ts_authkey }}" --hostname DEVXRDP

      # ---------- RDP ----------
      - name: Enable RDP
        shell: powershell
        run: |
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      # ---------- SESSION ----------
      - name: RDP Ready
        shell: powershell
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 | Select-Object -First 1
          Write-Host "======================"
          Write-Host "IP: $ip"
          Write-Host "USER: DEVXRDP"
          Write-Host "PASS: Rdp!9Xq#2025"
          Write-Host "======================"
          Start-Sleep -Seconds 18000

      # ---------- SAVE ----------
      - name: Save Data
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            C:\PersistentData
            C:\Users\DEVXRDP\Downloads
            C:\Users\DEVXRDP\AppData\Local\Google\Chrome\User Data
          key: devxrdp-minimal
