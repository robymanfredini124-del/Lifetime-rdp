name: DEVXRDP â€“ Persistent + Lock (Classic Style)

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale Auth Key"
        required: true
        type: string

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 305

    steps:
      - uses: actions/checkout@v4

      # ---------------- USER + DIRS (OLD STYLE) ----------------
      - name: Pre-Create User & Directories
        shell: powershell
        run: |
          $sec = ConvertTo-SecureString "Rdp!9Xq#2025" -AsPlainText -Force
          if (-not (Get-LocalUser -Name "DEVXRDP" -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name "DEVXRDP" -Password $sec -AccountNeverExpires
            Add-LocalGroupMember Administrators "DEVXRDP"
          }

          New-Item -Force -ItemType Directory -Path `
            "C:\Users\DEVXRDP\AppData\Local\Google\Chrome\User Data",
            "C:\Users\DEVXRDP\Downloads",
            "C:\PersistentData"

      # ---------------- RESTORE (CLONE) ----------------
      - name: Restore Previous RDP State
        uses: actions/cache/restore@v4
        with:
          path: |
            C:\Users\DEVXRDP\AppData\Local\Google\Chrome\User Data
            C:\Users\DEVXRDP\Downloads
            C:\PersistentData
          key: devxrdp-shared

      # ---------------- LOCK SCRIPT ----------------
      - name: Create Lock Script
        shell: powershell
        run: |
          $f = "C:\PersistentData\lock.ps1"
          echo 'Add-Type -AssemblyName Microsoft.VisualBasic' > $f
          echo '$p="DEVXRDP"' >> $f
          echo 'while($true){' >> $f
          echo ' $i=[Microsoft.VisualBasic.Interaction]::InputBox("Enter DEVXRDP Lock Password","DEVXRDP LOCK","")' >> $f
          echo ' if($i -eq $p){break}' >> $f
          echo '}' >> $f
          echo 'Stop-Process -Name explorer -Force' >> $f
          echo 'Start-Process explorer.exe' >> $f

      # ---------------- AUTO LOCK ----------------
      - name: Enable Lock on Login
        shell: powershell
        run: |
          $a = New-ScheduledTaskAction -Execute powershell.exe `
            -Argument "-ExecutionPolicy Bypass -File C:\PersistentData\lock.ps1"
          $t = New-ScheduledTaskTrigger -AtLogOn -User "DEVXRDP"
          Register-ScheduledTask DEVXRDP_LOCK $a $t -RunLevel Highest -Force

      # ---------------- TAILSCALE (OLD STYLE) ----------------
      - name: Start Tailscale
        shell: powershell
        run: |
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi -OutFile "$env:TEMP\tailscale.msi"
          Start-Process msiexec.exe -Wait -ArgumentList "/i","$env:TEMP\tailscale.msi","/quiet"
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey "${{ inputs.ts_authkey }}" `
            --hostname "DEVXRDP"

      # ---------------- ENABLE RDP ----------------
      - name: Enable RDP
        shell: powershell
        run: |
          Set-ItemProperty HKLM:\System\CurrentControlSet\Control\TerminalServer fDenyTSConnections 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      # ---------------- ACTIVE ----------------
      - name: RDP Active
        shell: powershell
        run: |
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 | Select-Object -First 1
          Write-Host "IP: $ip"
          Write-Host "User: DEVXRDP"
          Write-Host "Pass: Rdp!9Xq#2025"

          try {
            Start-Sleep -Seconds 18000
          } finally {
            Write-Host "Saving state..."
          }

      # ---------------- SAVE ALWAYS ----------------
      - name: Save State (Always)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            C:\Users\DEVXRDP\AppData\Local\Google\Chrome\User Data
            C:\Users\DEVXRDP\Downloads
            C:\PersistentData
          key: devxrdp-shared
