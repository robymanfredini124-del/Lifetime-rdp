name: DEVXRDP â€“ Clone + Lock (Final Stable)

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale Auth Key"
        required: true
        type: string

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 300

    steps:
      - uses: actions/checkout@v4

      # ================= USER (SAME AS OLD) =================
      - name: Create DEVXRDP User
        shell: powershell
        run: |
          $pass = ConvertTo-SecureString "Rdp!9Xq#2025" -AsPlainText -Force
          if (-not (Get-LocalUser DEVXRDP -ErrorAction SilentlyContinue)) {
            New-LocalUser DEVXRDP -Password $pass -AccountNeverExpires
            Add-LocalGroupMember Administrators DEVXRDP
          }

      # ================= DIRECTORIES =================
      - name: Prepare Persistent Paths
        shell: powershell
        run: |
          New-Item -Force -ItemType Directory `
            "C:\PersistentData",
            "C:\Users\DEVXRDP\AppData\Local\Google\Chrome\User Data",
            "C:\Users\DEVXRDP\Downloads"

      # ================= RESTORE CLONE =================
      - name: Restore Clone Data
        uses: actions/cache/restore@v4
        with:
          path: |
            C:\PersistentData
            C:\Users\DEVXRDP\AppData\Local\Google\Chrome\User Data
            C:\Users\DEVXRDP\Downloads
          key: devxrdp-clone

      # ================= LOCK SCRIPT =================
      - name: Create Lock Script
        shell: powershell
        run: |
          $lock = "C:\PersistentData\lock.ps1"
          @'
Add-Type -AssemblyName Microsoft.VisualBasic
$correct = "DEVXKINGRDP"
do {
  $input = [Microsoft.VisualBasic.Interaction]::InputBox(
    "Enter DEVXRDP Lock Password",
    "DEVXRDP LOCK",
    ""
  )
} until ($input -eq $correct)
'@ | Set-Content $lock

      # ================= SCHEDULE LOCK =================
      - name: Enable Lock On Login
        shell: powershell
        run: |
          $action  = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -File C:\PersistentData\lock.ps1"
          $trigger = New-ScheduledTaskTrigger -AtLogOn -User "DEVXRDP"
          Register-ScheduledTask -TaskName "DEVXRDP_LOCK" -Action $action -Trigger $trigger -RunLevel Highest -Force

      # ================= TAILSCALE =================
      - name: Install & Start Tailscale
        shell: powershell
        run: |
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi -OutFile tailscale.msi
          Start-Process msiexec.exe -Wait -ArgumentList "/i tailscale.msi /quiet"
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey "${{ inputs.ts_authkey }}" --hostname DEVXRDP

      # ================= ENABLE RDP =================
      - name: Enable RDP
        shell: powershell
        run: |
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      # ================= SESSION =================
      - name: RDP Ready
        shell: powershell
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 | Select-Object -First 1
          Write-Host "========================"
          Write-Host "IP: $ip"
          Write-Host "USER: DEVXRDP"
          Write-Host "PASS: Rdp!9Xq#2025"
          Write-Host "LOCK: DEVXKINGRDP"
          Write-Host "========================"
          Start-Sleep -Seconds 18000

      # ================= SAVE CLONE =================
      - name: Save Clone State
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            C:\PersistentData
            C:\Users\DEVXRDP\AppData\Local\Google\Chrome\User Data
            C:\Users\DEVXRDP\Downloads
          key: devxrdp-clone
